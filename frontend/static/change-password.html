<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Yummy(맛나) - 비밀번호 변경</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/common.css">
</head>
<body class="login-page">
  <main class="login-box">
    <h1>비밀번호 변경</h1>
    <p class="subtitle">새 비밀번호를 입력해주세요</p>
    <form id="changePasswordForm">
      <input type="password" id="currentPassword" placeholder="현재 비밀번호" required autocomplete="current-password">
      <input type="password" id="newPassword" placeholder="새 비밀번호 (4자 이상)" required autocomplete="new-password" minlength="4">
      <input type="password" id="confirmPassword" placeholder="새 비밀번호 확인" required autocomplete="new-password" minlength="4">
      <button type="submit">변경하기</button>
    </form>
    <p id="error" class="error"></p>
  </main>
  <script src="/js/api.js"></script>
  <script>
    (async () => {
      const user = await api.me();
      if (!user) {
        location.href = '/';
        return;
      }
      if (!user.must_change_password) {
        location.href = user.role === 'ADMIN' ? '/admin.html' : '/driver.html';
        return;
      }
    })();

    document.getElementById('changePasswordForm').onsubmit = async (e) => {
      e.preventDefault();
      const err = document.getElementById('error');
      err.textContent = '';
      const current = document.getElementById('currentPassword').value;
      const newPw = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      if (newPw.length < 4) {
        err.textContent = '새 비밀번호는 4자 이상 입력하세요.';
        return;
      }
      if (newPw !== confirm) {
        err.textContent = '새 비밀번호가 일치하지 않습니다.';
        return;
      }
      try {
        await api.changePassword(current, newPw);
        alert('비밀번호가 변경되었습니다.');
        const user = await api.me();
        location.href = user?.role === 'ADMIN' ? '/admin.html' : '/driver.html';
      } catch (e) {
        err.textContent = e.detail || e.message || '비밀번호 변경 실패';
      }
    };
  </script>
</body>
</html>
