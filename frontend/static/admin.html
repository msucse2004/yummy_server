<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>(주) 맛나 - 관리자</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <h1>(주) 맛나 관리자</h1>
      <button class="logout" onclick="doLogout()">로그아웃</button>
    </header>
    <main class="app-content">
      <nav class="nav-tabs">
        <a href="#" class="active" data-tab="plans">배송 플랜</a>
        <a href="#" data-tab="customers">거래처</a>
        <a href="#" data-tab="arrears">수금</a>
        <a href="#" data-tab="items">품목</a>
        <a href="#" data-tab="users">사용자</a>
        <a href="#" data-tab="reports">리포트</a>
        <a href="#" data-tab="settings">설정</a>
      </nav>

      <div id="tab-plans" class="tab-content">
        <div id="planListPanel">
          <div class="card">
            <h2>플랜 목록</h2>
            <p><button class="btn btn-primary" onclick="showPlanForm()">+ 새 플랜</button></p>
            <table><thead><tr>
              <th class="sortable" data-sort="plan_date">날짜 <span class="sort-icon"></span></th>
              <th>배달 수량</th>
              <th class="sortable" data-sort="daily_sales">일일매출 <span class="sort-icon"></span></th>
              <th></th>
            </tr></thead><tbody id="plansList"></tbody></table>
          </div>
          <div id="planDetail" style="display:none"></div>
        </div>
        <div id="newPlanFullScreen" class="new-plan-fullscreen" style="display:none">
          <div class="new-plan-content">
            <h2 id="newPlanTitle">2026년 2월 16일 배달 플랜</h2>
            <p class="new-plan-date-row">
              <label for="newPlanDate">배달 날짜</label>
              <input type="date" id="newPlanDate" onchange="updateNewPlanTitleFromDate()">
            </p>
            <p class="new-plan-actions">
              <button type="button" class="btn btn-secondary" onclick="closeNewPlanForm()">취소</button>
              <button type="button" class="btn btn-primary" onclick="saveNewPlanFromList()">저장</button>
            </p>
            <table class="new-plan-table">
              <thead><tr><th>코드</th><th>루트</th><th>이름</th><th>배달 항목</th></tr></thead>
              <tbody id="newPlanTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-customers" class="tab-content" style="display:none">
        <div class="card">
          <h2>거래처</h2>
          <p>
            <input type="text" id="customerSearchInput" placeholder="코드, 상호, 주소 등 검색" style="max-width:280px; margin-right:0.5rem; padding:0.4rem 0.6rem;">
            <button class="btn btn-primary" type="button" onclick="showCustomerForm()">+ 추가</button>
            <button class="btn btn-secondary" type="button" onclick="exportCustomersExcel()">Excel 내보내기</button>
            <label class="btn btn-secondary" style="margin:0; cursor:pointer">
              Excel 가져오기
              <input type="file" id="customerExcelInput" accept=".xlsx" style="display:none" onchange="importCustomersExcel(event)">
            </label>
            <button class="btn btn-secondary" type="button" onclick="deleteAllCustomers()" style="color:var(--highlight)">거래처 전체 지우기</button>
          </p>
          <table><thead><tr>
  <th class="sortable" data-sort="code">코드 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="route">루트 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="name">상호 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="business_registration_number">사업자번호 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="representative_name">대표 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="contract">계약 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="business_type">업태 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="business_category">종목 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="arrears">미수금액 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="contract_content">계약내용 <span class="sort-icon"></span></th>
  <th class="sortable" data-sort="address">주소 <span class="sort-icon"></span></th>
  <th></th>
</tr></thead><tbody id="customersList"></tbody></table>
        </div>
      </div>

      <div id="tab-arrears" class="tab-content" style="display:none">
        <div class="card">
          <h2>수금</h2>
          <p>
            <input type="text" id="arrearsSearchInput" placeholder="코드, 상호, 주소 등 검색" style="max-width:280px; margin-right:0.5rem; padding:0.4rem 0.6rem;">
            거래처별 미수금 현황
          </p>
          <table><thead><tr>
            <th class="sortable" data-sort="code">코드 <span class="sort-icon"></span></th>
            <th class="sortable" data-sort="name">상호 <span class="sort-icon"></span></th>
            <th class="sortable" data-sort="arrears">미수금액 <span class="sort-icon"></span></th>
            <th>변제</th>
          </tr></thead><tbody id="arrearsList"></tbody></table>
        </div>
      </div>

      <div id="partialRepayModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closePartialRepayModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3>미수금 변제</h3>
          <p id="partialRepayCustomerName" class="form-group"></p>
          <p class="form-group">
            <button type="button" class="btn btn-primary" onclick="doFullRepaymentFromModal()">전액변제</button>
          </p>
          <p class="form-group">
            <label for="partialRepayAmount">부분 변제 금액 (원)</label>
            <input type="number" id="partialRepayAmount" min="1" step="1" placeholder="금액 입력">
          </p>
          <p class="form-group"><small id="partialRepayCurrentArrears"></small></p>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closePartialRepayModal()">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitPartialRepay()">부분변제</button>
          </div>
        </div>
      </div>

      <div id="tab-items" class="tab-content" style="display:none">
        <div class="card">
          <h2>품목</h2>
          <p>
            <input type="text" id="itemSearchInput" placeholder="코드, 상품, 단위, 설명 등 검색" style="max-width:280px; margin-right:0.5rem; padding:0.4rem 0.6rem;">
            <button class="btn btn-primary" type="button" onclick="showItemForm()">+ 추가</button>
            <button class="btn btn-secondary" type="button" onclick="exportItemsExcel()">Excel 내보내기</button>
            <label class="btn btn-secondary" style="margin:0; cursor:pointer">
              Excel 가져오기
              <input type="file" id="itemExcelInput" accept=".xlsx" style="display:none" onchange="importItemsExcel(event)">
            </label>
          </p>
          <table><thead><tr><th>코드</th><th>상품</th><th>단위</th><th>단가 (원)</th><th>설명</th><th></th></tr></thead><tbody id="itemsList"></tbody></table>
        </div>
      </div>

      <div id="tab-users" class="tab-content" style="display:none">
        <div class="card">
          <h2>사용자</h2>
          <p>
            <input type="text" id="userSearchInput" placeholder="아이디, 이름, 전화번호 등 검색" style="max-width:280px; margin-right:0.5rem; padding:0.4rem 0.6rem;">
            <button class="btn btn-primary" type="button" onclick="showUserForm()">+ 추가</button>
            <button class="btn btn-secondary" type="button" onclick="exportUsersExcel()">Excel 내보내기</button>
            <label class="btn btn-secondary" style="margin:0; cursor:pointer">
              Excel 가져오기
              <input type="file" id="userExcelInput" accept=".xlsx" style="display:none" onchange="importUsersExcel(event)">
            </label>
          </p>
          <table><thead><tr><th>아이디</th><th>권한</th><th>이름</th><th>전화번호</th><th>부서배정</th><th>선호언어</th><th>상태</th><th></th></tr></thead><tbody id="usersList"></tbody></table>
        </div>
      </div>

      <div id="departmentEditModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeDepartmentEditModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3>부서 배정</h3>
          <p id="departmentEditUserName" class="form-group"></p>
          <p class="form-group">
            <label for="departmentEditSelect">부서(루트)</label>
            <select id="departmentEditSelect">
              <option value="">선택</option>
            </select>
          </p>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDepartmentEditModal()">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitDepartmentEdit()">저장</button>
          </div>
        </div>
      </div>

      <div id="approveUserModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeApproveUserModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3>승인 및 부서 배정</h3>
          <p id="approveUserName" class="form-group"></p>
          <p class="form-group">
            <label for="approveDepartmentSelect">부서(루트) *</label>
            <select id="approveDepartmentSelect">
              <option value="">선택</option>
            </select>
          </p>
          <p id="approveError" class="error" style="margin-top:0.5rem; font-size:0.9rem;"></p>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeApproveUserModal()">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitApproveUser()">승인</button>
          </div>
        </div>
      </div>

      <div id="statusEditModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeStatusEditModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3>사용자 상태 변경</h3>
          <p id="statusEditUserName" class="form-group"></p>
          <p class="form-group">
            <label for="statusEditSelect">상태</label>
            <select id="statusEditSelect">
              <option value="">선택</option>
              <option value="승인요청중">승인요청중</option>
              <option value="재직">재직</option>
              <option value="퇴사">퇴사</option>
            </select>
          </p>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeStatusEditModal()">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitStatusEdit()">저장</button>
          </div>
        </div>
      </div>

      <div id="passwordChangeModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closePasswordChangeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3>비밀번호 변경</h3>
          <p id="passwordChangeUserName" class="form-group"></p>
          <div class="form-group">
            <label><input type="radio" name="passwordChangeMode" value="admin" checked> 관리자가 비밀번호 직접 변경</label>
          </div>
          <div id="passwordChangeAdminPanel" class="form-group">
            <label for="passwordChangeNew">새 비밀번호</label>
            <input type="password" id="passwordChangeNew" placeholder="4자 이상" minlength="4">
          </div>
          <div class="form-group">
            <label><input type="radio" name="passwordChangeMode" value="user"> 사용자가 변경 (임시 비밀번호 설정)</label>
            <div id="passwordChangeUserPanel" class="form-group" style="display:none; margin-left:1.5rem;">
              <label for="passwordChangeTemporary">임시 비밀번호</label>
              <input type="password" id="passwordChangeTemporary" placeholder="4자 이상" minlength="4">
              <p class="form-help">사용자가 이 비밀번호로 로그인하면 비밀번호 변경 페이지로 이동합니다.</p>
            </div>
          </div>
          <p id="passwordChangeError" class="error" style="margin-top:0.5rem; font-size:0.9rem;"></p>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closePasswordChangeModal()">취소</button>
            <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">적용</button>
          </div>
        </div>
      </div>

      <div id="userModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeUserModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
          <h3 id="userModalTitle">사용자 추가</h3>
          <form id="userForm">
            <input type="hidden" id="userId" value="">
            <div class="form-group">
              <label for="userUsername">아이디 *</label>
              <input type="text" id="userUsername" required placeholder="아이디 (한글, 영문, 숫자 등)" autocomplete="username" maxlength="64">
            </div>
            <div class="form-group" id="userPasswordGroup">
              <label for="userPassword">비밀번호 *</label>
              <input type="password" id="userPassword" placeholder="6자 이상" minlength="6" autocomplete="new-password">
            </div>
            <div class="form-group">
              <label for="userDisplayName">이름</label>
              <input type="text" id="userDisplayName" placeholder="이름">
            </div>
            <div class="form-group">
              <label for="userRole">권한</label>
              <select id="userRole">
                <option value="DRIVER">기사</option>
                <option value="ADMIN">관리자</option>
              </select>
            </div>
            <div class="form-group">
              <label for="userSsn">주민번호</label>
              <input type="text" id="userSsn" placeholder="주민번호">
            </div>
            <div class="form-group">
              <label for="userPhone">전화번호</label>
              <input type="text" id="userPhone" placeholder="전화번호">
            </div>
            <div class="form-group">
              <label for="userDepartment">부서배정</label>
              <input type="text" id="userDepartment" placeholder="예: 1호차, 배송팀">
            </div>
            <div class="form-group">
              <label for="userResume">이력서</label>
              <input type="text" id="userResume" placeholder="이력서">
            </div>
            <div class="form-group">
              <label for="userPreferredLocale">선호언어</label>
              <select id="userPreferredLocale">
                <option value="대한민국">🇰🇷 한국어</option>
                <option value="미국">🇺🇸 English</option>
                <option value="일본">🇯🇵 日本語</option>
                <option value="简体中文">🇨🇳 简体中文</option>
                <option value="繁體中文">🇨🇳 繁體中文</option>
                <option value="베트남">🇻🇳 Tiếng Việt</option>
                <option value="라오스">🇱🇦 ພາສາລາວ</option>
                <option value="캄보디아">🇰🇭 ភាសាខ្មែរ</option>
                <option value="인도">🇮🇳 हिन्दी</option>
                <option value="파키스탄">🇵🇰 اردو</option>
              </select>
            </div>
            <div class="form-group">
              <label for="userStatus">상태</label>
              <select id="userStatus">
                <option value="">선택</option>
                <option value="승인요청중">승인요청중</option>
                <option value="재직">재직</option>
                <option value="퇴사">퇴사</option>
              </select>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn btn-secondary" onclick="closeUserModal()">취소</button>
              <button type="submit" class="btn btn-primary">저장</button>
            </div>
          </form>
        </div>
      </div>

      <div id="tab-reports" class="tab-content" style="display:none">
        <div class="card">
          <h2>월말 정산 리포트</h2>
          <p>
            <input type="number" id="reportYear" placeholder="년" min="2020" value="2025">
            <input type="number" id="reportMonth" placeholder="월" min="1" max="12" value="2">
            <a href="#" class="btn btn-primary" onclick="downloadReport()">PDF 다운로드</a>
          </p>
        </div>
      </div>

      <div id="tab-settings" class="tab-content" style="display:none">
        <div class="card">
          <h2>설정</h2>
          <form id="settingsForm">
            <div class="form-group">
              <label for="settingCompanyName">회사 이름</label>
              <input type="text" id="settingCompanyName" placeholder="회사 이름">
            </div>
            <div class="form-group">
              <label for="settingBusinessRegNum">사업자 등록 번호</label>
              <input type="text" id="settingBusinessRegNum" placeholder="000-00-00000">
            </div>
            <div class="form-group">
              <label for="settingRepresentativeName">대표이름</label>
              <input type="text" id="settingRepresentativeName" placeholder="대표자명">
            </div>
            <div class="form-group">
              <label for="settingCompanyAddress">회사 주소</label>
              <div class="address-input-wrap">
                <input type="text" id="settingCompanyAddress" placeholder="회사 주소">
                <span id="settingAddressStatus" class="address-status" title="주소를 입력 후 변경 시 위도/경도 검증"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="settingCompanyPhone">회사 전화번호</label>
              <input type="text" id="settingCompanyPhone" placeholder="회사 전화번호">
            </div>
            <div class="form-group">
              <label for="settingBusinessType">업태</label>
              <input type="text" id="settingBusinessType" placeholder="업태">
            </div>
            <div class="form-group">
              <label for="settingBusinessCategory">종목</label>
              <input type="text" id="settingBusinessCategory" placeholder="종목">
            </div>
            <div class="form-group">
              <label for="settingBankName">은행명</label>
              <input type="text" id="settingBankName" placeholder="예: KB국민은행">
            </div>
            <div class="form-group">
              <label for="settingBankAccount">계좌번호</label>
              <input type="text" id="settingBankAccount" placeholder="예: 796801-00-111509">
            </div>
            <div class="form-group">
              <label for="settingBankHolder">예금주</label>
              <input type="text" id="settingBankHolder" placeholder="예금주명">
            </div>
            <div class="form-group">
              <label for="settingDeliveryRouteCount">배달 루트</label>
              <input type="number" id="settingDeliveryRouteCount" min="1" max="99" placeholder="개수"> 개
            </div>
            <div class="modal-actions">
              <button type="submit" class="btn btn-primary">저장</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="itemModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeItemModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3 id="itemModalTitle">품목 추가</h3>
      <form id="itemForm">
        <input type="hidden" id="itemId" value="">
        <div class="form-group">
          <label for="itemProduct">상품 *</label>
          <input type="text" id="itemProduct" required placeholder="상품명">
        </div>
        <div class="form-group">
          <label for="itemUnit">단위</label>
          <select id="itemUnit">
            <option value="박스">박스</option>
            <option value="판">판</option>
            <option value="관">관</option>
          </select>
        </div>
        <div class="form-group">
          <label for="itemUnitPrice">단가 (원)</label>
          <input type="number" id="itemUnitPrice" placeholder="원" step="1" min="0">
        </div>
        <div class="form-group">
          <label for="itemDescription">설명</label>
          <input type="text" id="itemDescription" placeholder="설명">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeItemModal()">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <div id="planModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closePlanModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3>플랜 수정</h3>
      <form id="planForm">
        <input type="hidden" id="planId" value="">
        <div class="form-group">
          <label for="planDate">배달 날짜 *</label>
          <input type="date" id="planDate" required>
        </div>
        <div class="form-group">
          <label for="planName">플랜 이름 *</label>
          <input type="text" id="planName" required placeholder="예: 2026-02-16 배달">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closePlanModal()">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <div id="customerRouteEditModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeCustomerRouteEditModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3>루트 변경</h3>
      <p id="customerRouteEditName" class="form-group"></p>
      <p class="form-group">
        <label for="customerRouteEditSelect">루트</label>
        <select id="customerRouteEditSelect">
          <option value="">선택</option>
        </select>
      </p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeCustomerRouteEditModal()">취소</button>
        <button type="button" class="btn btn-primary" onclick="submitCustomerRouteEdit()">저장</button>
      </div>
    </div>
  </div>

  <div id="customerModal" class="modal-overlay" style="display:none" onclick="if(event.target===this) closeCustomerModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3 id="customerModalTitle">거래처 추가</h3>
      <form id="customerForm">
        <input type="hidden" id="customerId" value="">
        <div class="form-group">
          <label for="customerCode">코드</label>
          <input type="text" id="customerCode" placeholder="거래처 코드 (비우면 자동생성)">
        </div>
        <div class="form-group">
          <label for="customerRoute">루트</label>
          <select id="customerRoute">
            <option value="">선택</option>
          </select>
        </div>
        <div class="form-group">
          <label for="customerName">이름 *</label>
          <input type="text" id="customerName" required placeholder="거래처 이름">
        </div>
        <div class="form-group">
          <label for="customerBusinessRegNum">사업자번호</label>
          <input type="text" id="customerBusinessRegNum" placeholder="000-00-00000">
        </div>
        <div class="form-group">
          <label for="customerRepresentative">대표</label>
          <input type="text" id="customerRepresentative" placeholder="대표자명">
        </div>
        <div class="form-group">
          <label for="customerPhone">연락처</label>
          <input type="text" id="customerPhone" placeholder="전화번호">
        </div>
        <div class="form-group">
          <label for="customerContract">계약</label>
          <select id="customerContract">
            <option value="">선택</option>
            <option value="계약">계약</option>
            <option value="해지">해지</option>
          </select>
        </div>
        <div class="form-group">
          <label>계약 내용</label>
          <div class="contract-input-mode">
            <label><input type="radio" name="contractInputMode" value="select" checked> 품목 선택</label>
            <label><input type="radio" name="contractInputMode" value="text"> 텍스트 입력</label>
          </div>
          <div id="contractContentSelectMode" class="contract-mode-panel">
            <div id="contractContentItems"></div>
            <p><button type="button" class="btn btn-secondary" onclick="addContractItemRow()">+ 품목 추가</button></p>
          </div>
          <div id="contractContentTextMode" class="contract-mode-panel" style="display:none">
            <textarea id="customerContractContentText" rows="3" placeholder="예: 곱슬이 2박스, 일자 3박스, 두부 3판, 도토리묵 5판"></textarea>
            <p><button type="button" class="btn btn-secondary" onclick="matchContractContent()">맵핑 확인</button>
            <span id="contractMatchResult" class="contract-match-result"></span></p>
          </div>
        </div>
        <div class="form-group">
          <label for="customerBusinessType">업태</label>
          <input type="text" id="customerBusinessType" placeholder="업태">
        </div>
        <div class="form-group">
          <label for="customerBusinessCategory">종목</label>
          <input type="text" id="customerBusinessCategory" placeholder="종목">
        </div>
        <div class="form-group">
          <label for="customerArrears">미수금액 (원)</label>
          <input type="number" id="customerArrears" placeholder="0" min="0" step="1">
        </div>
        <div class="form-group">
          <label for="customerAddress">주소</label>
          <input type="text" id="customerAddress" placeholder="주소">
        </div>
        <div class="form-group" style="display:none">
          <label for="customerLatitude">위도</label>
          <input type="number" id="customerLatitude" placeholder="위도 (예: 37.5666805)" step="any">
        </div>
        <div class="form-group" style="display:none">
          <label for="customerLongitude">경도</label>
          <input type="number" id="customerLongitude" placeholder="경도 (예: 126.9784147)" step="any">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="/js/api.js"></script>
  <script src="/js/admin.js?v=2"></script>
</body>
</html>
